# HTTP-сервер — только частичный редирект
server {
    listen 80;
    listen [::]:80;
    server_name monitor.slavapmk.ru;
    server_tokens off;

    # Для Let's Encrypt — оставляем доступ по HTTP
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Только корень и "человеческие" пути редиректим на HTTPS
    location = / {
        return 301 https://$host$request_uri;
    }

    # Всё остальное — проксируем по HTTP без редиректа
    location / {
        proxy_pass http://ethercheck-backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Важно: не ставим X-Forwarded-Proto https здесь — оставляем http
    }

    # Копируем те же специальные локации, что и на 443
    location ~ ^/upload/([^/]+)(/.*)?$ {
        proxy_pass http://ethercheck-backend:8080/api/upload/$1$2;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /list/ {
        alias /app/data/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        default_type application/octet-stream;
        types {
            text/plain txt log csv json md;
            text/html html htm;
            image/png png;
            image/jpeg jpg jpeg;
            application/pdf pdf;
        }
    }
}

# HTTPS-сервер — полный доступ, без редиректов
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name monitor.slavapmk.ru;

    ssl_certificate /etc/nginx/ssl/live/monitor.slavapmk.ru/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/monitor.slavapmk.ru/privkey.pem;

    client_max_body_size 100M;

    location / {
        proxy_pass http://ethercheck-backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;  # будет "https"
    }

    location ~ ^/upload/([^/]+)(/.*)?$ {
        proxy_pass http://ethercheck-backend:8080/api/upload/$1$2;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /list/ {
        alias /app/data/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        default_type application/octet-stream;
        types {
            text/plain txt log csv json md;
            text/html html htm;
            image/png png;
            image/jpeg jpg jpeg;
            application/pdf pdf;
        }
    }
}