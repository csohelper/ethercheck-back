<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Потери пакетов</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: system-ui, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        .card {
            background: #161b22;
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1600px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .rooms-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #30363d;
            padding: 10px;
            border-radius: 6px;
            background: #0d1117;
        }

        .rooms-list label {
            display: block;
            margin-bottom: 5px;
            color: #c9d1d9;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 70vh;
            touch-action: none;
            -ms-touch-action: none;
        }

        canvas {
            touch-action: none !important;
            -ms-touch-action: none !important;
        }

        .stats {
            font-size: 1.3em;
            margin: 15px 0;
        }

        .alarm {
            color: #ff5555;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 1.1em;
            background: #238636;
            color: #c9d1d9;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #2ea043;
        }

        input[type="text"] {
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px;
            border-radius: 6px;
        }

        .flatpickr-calendar {
            background: #161b22;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .flatpickr-month {
            color: #c9d1d9;
        }

        .flatpickr-weekdays {
            background: #0d1117;
        }

        .flatpickr-day {
            color: #c9d1d9;
            border-color: #30363d;
        }

        .flatpickr-day:hover {
            background: #30363d;
        }

        .flatpickr-day.selected {
            background: #238636;
            color: #c9d1d9;
        }

        .flatpickr-time {
            background: #161b22;
            border-top: 1px solid #30363d;
        }

        .flatpickr-time input {
            color: #c9d1d9;
        }

        .flatpickr-time .numInputWrapper:hover {
            background: #30363d;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #161b22;
            color: #c9d1d9;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 10px;
                margin: 10px auto;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls > div {
                margin-bottom: 10px;
            }

            .rooms-list {
                max-height: 200px;
            }

            .chart-container {
                height: 50vh;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="card">
    <h1>Потери пакетов</h1>
    <div class="controls">
        <div>
            <label>Начало:</label><br>
            <input id="start">
        </div>
        <div>
            <label>Конец:</label><br>
            <input id="end">
        </div>
        <div>
            <label>Комнаты:</label><br>
            <div class="rooms-list">
                <label>
                    <input type="checkbox" name="rooms" value="total" checked> Все комнаты
                </label>
                {% for room in rooms %}
                <label>
                    <input type="checkbox" name="rooms" value="{{ room }}"> Комната {{ room }}
                </label>
                {% endfor %}
            </div>
        </div>
        <button onclick="load()">Показать</button>
    </div>
    <div id="stats" class="stats"></div>
    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
</div>
<script>
    luxon.Settings.defaultLocale = 'ru';
    let chart = null;

    // Установка дат по умолчанию
    const now = luxon.DateTime.now();
    const startDefault = now.minus({ hours: 8 }).toFormat('yyyy-MM-dd HH:mm');
    const endDefault = now.toFormat('yyyy-MM-dd HH:mm');

    document.getElementById("start").value = startDefault;
    document.getElementById("end").value = endDefault;

    flatpickr("#start,#end", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minuteIncrement: 60
    });

    // === НОВАЯ ЛОГИКА ЧЕКБОКСОВ ===
    const totalCheckbox = document.querySelector('input[value="total"]');
    const roomCheckboxes = document.querySelectorAll('input[name="rooms"]:not([value="total"])');

    // Обработчик изменения любого чекбокса
    document.querySelectorAll('input[name="rooms"]').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            if (this.value === 'total') {
                // Клик по "Суммарно по всем комнатам"
                if (this.checked) {
                    roomCheckboxes.forEach(cb => cb.checked = false);
                }
            } else {
                // Клик по отдельной комнате
                if (this.checked) {
                    totalCheckbox.checked = false;
                } else {
                    // Если сняли последнюю комнату — автоматически включаем "Все"
                    const anyRoomChecked = Array.from(roomCheckboxes).some(cb => cb.checked);
                    if (!anyRoomChecked) {
                        totalCheckbox.checked = true;
                    }
                }
            }
        });
    });

    // Инициализация: если "Все" уже отмечено — снимаем остальные (на всякий случай)
    if (totalCheckbox.checked) {
        roomCheckboxes.forEach(cb => cb.checked = false);
    }

    // Больше НИКАКИХ disabled! Все чекбоксы всегда активны

    async function load() {
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const rooms = Array.from(document.querySelectorAll('input[name="rooms"]:checked'))
            .map(input => input.value)
            .filter(val => val !== 'total')  // "total" не отпавляем на бэк
            .join(",");

        // Если выбрано "total" или ничего не выбрано — отправляем пустую строку или специальное значение
        const finalRooms = totalCheckbox.checked || rooms === "" ? "total" : rooms;

        const resp = await fetch(`/api/graph?start=${start}&end=${end}&rooms=${finalRooms}`);
        const json = await resp.json();

        if (chart) chart.destroy();
        const ctx = document.getElementById("chart").getContext("2d");
        chart = new Chart(ctx, {
            type: "line",
            data: {datasets: json.datasets},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                elements: {
                    point: {radius: 0, hitRadius: 100, hoverRadius: 6},
                    line: {borderWidth: 2}
                },
                scales: {
                    x: {
                        type: "time",
                        time: {
                            unit: "minute",
                            displayFormats: {
                                minute: 'dd.MM HH:mm',
                                hour: 'dd.MM HH:mm'
                            }
                        },
                        ticks: {autoSkip: true, maxTicksLimit: 12, maxRotation: 90, minRotation: 0}
                    },
                    y: {min: 0, max: 100}
                },
                plugins: {
                    legend: {
                        position: "top"
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'nearest',
                        intersect: false,
                        filter: function (tooltipItem) {
                            return tooltipItem.parsed.y > 0;
                        },
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                            }
                        }
                    },
                    zoom: {
                        limits: {
                            x: {min: 'original', max: 'original'},
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                            modifierKey: null,
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                                // speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    intersect: false
                }
            }
        });
    }

    window.onload = () => load();
</script>
</body>
</html>