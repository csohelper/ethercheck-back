<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Потери пакетов — Ethernet мониторинг</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {font-family: system-ui,sans-serif; background:#0d1117; color:#c9d1d9; margin:0; padding:20px;}
        .card {background:#161b22; border-radius:12px; padding:20px; margin:20px auto; max-width:1600px;}
        .controls {display:flex; flex-wrap:wrap; gap:20px; align-items:end; margin-bottom:20px;}
        select[multiple] {height:300px;}
        canvas {width:100%!important; height:70vh!important;}
        .stats {font-size:1.3em; margin:15px 0;}
        .alarm {color:#ff5555; font-weight:bold;}
        button {padding:10px 20px; font-size:1.1em;}
    </style>
</head>
<body>
<div class="card">
    <h1>Ethernet — потери пакетов (режим: по часам)</h1>
    <div class="controls">
        <div>
            <label>Начало (час):</label><br>
            <input id="start" value="2025-11-19 00">
        </div>
        <div>
            <label>Конец (час):</label><br>
            <input id="end" value="2025-11-19 23">
        </div>
        <div>
            <label>Комнаты:</label><br>
            <select id="rooms" multiple size="10">
                <option value="total" selected>Суммарно по всем комнатам</option>
                {% for room in rooms %}
                <option value="{{ room }}">Комната {{ room }}</option>
                {% endfor %}
            </select>
        </div>
        <button onclick="load()">Показать</button>
    </div>
    <div id="stats" class="stats"></div>
    <canvas id="chart"></canvas>
</div>

<script>
let chart = null;
flatpickr("#start,#end", {enableTime:false, dateFormat:"Y-m-d H", time_24hr:true});

async function load() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    const rooms = Array.from(document.querySelectorAll("#rooms option:checked")).map(o=>o.value).join(",");

    const resp = await fetch(`/api/data?start=${start}&end=${end}&rooms=${rooms}`);
    const json = await resp.json();

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById("chart"), {
        type: "line",
        data: {datasets: json.datasets},
        options: {
            animation: false,
            scales: {
                x: {type: "time", time: {unit: "hour", displayFormats: {hour: "HH:mm"}}},
                y: {beginAtZero: true}
            },
            plugins: {legend: {position: "top"}}
        }
    });

    let total = 0, max = 0;
    json.datasets.forEach(ds => ds.data.forEach(p => {
        total += p.y;
        if (p.y > max) max = p.y;
    }));
    document.getElementById("stats").innerHTML = `
        Период: ${start}:00 — ${end}:59<br>
        Всего потеряно: <b>${total}</b> пакетов | 
        Максимум за минуту: <b>${max}</b>
        ${max > 100 ? '<span class="alarm">ТРЕВОГА!</span>' : ''}
    `;
}
window.onload = () => load();
</script>
</body>
</html>