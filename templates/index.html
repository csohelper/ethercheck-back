<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Потери пакетов — Ethernet мониторинг</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }

        .card {
            background: #161b22;
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1600px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .rooms-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #30363d;
            padding: 10px;
            border-radius: 6px;
            background: #0d1117;
        }

        .rooms-list label {
            display: block;
            margin-bottom: 5px;
            color: #c9d1d9;
        }

        canvas {
            width: 100% !important;
            height: 70vh !important;
        }

        .stats {
            font-size: 1.3em;
            margin: 15px 0;
        }

        .alarm {
            color: #ff5555;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 1.1em;
            background: #238636;
            color: #c9d1d9;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #2ea043;
        }

        input[type="text"] {
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px;
            border-radius: 6px;
        }

        /* Flatpickr dark theme overrides */
        .flatpickr-calendar {
            background: #161b22;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .flatpickr-month {
            color: #c9d1d9;
        }

        .flatpickr-weekdays {
            background: #0d1117;
        }

        .flatpickr-day {
            color: #c9d1d9;
            border-color: #30363d;
        }

        .flatpickr-day:hover {
            background: #30363d;
        }

        .flatpickr-day.selected {
            background: #238636;
            color: #c9d1d9;
        }

        .flatpickr-time {
            background: #161b22;
            border-top: 1px solid #30363d;
        }

        .flatpickr-time input {
            color: #c9d1d9;
        }

        .flatpickr-time .numInputWrapper:hover {
            background: #30363d;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #161b22;
            color: #c9d1d9;
        }

        /* Mobile adaptations */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 10px;
                margin: 10px auto;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls > div {
                margin-bottom: 10px;
            }

            .rooms-list {
                max-height: 200px;
            }

            canvas {
                height: 50vh !important;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="card">
    <h1>Ethernet — потери пакетов (режим: по часам)</h1>
    <div class="controls">
        <div>
            <label>Начало (час):</label><br>
            <input id="start" value="2025-11-19 00">
        </div>
        <div>
            <label>Конец (час):</label><br>
            <input id="end" value="2025-11-19 23">
        </div>
        <div>
            <label>Комнаты:</label><br>
            <div class="rooms-list">
                <label>
                    <input type="checkbox" name="rooms" value="total" checked> Суммарно по всем комнатам
                </label>
                {% for room in rooms %}
                <label>
                    <input type="checkbox" name="rooms" value="{{ room }}"> Комната {{ room }}
                </label>
                {% endfor %}
            </div>
        </div>
        <button onclick="load()">Показать</button>
    </div>
    <div id="stats" class="stats"></div>
    <canvas id="chart"></canvas>
</div>

<script>
    luxon.Settings.defaultLocale = 'en';

    let chart = null;
    flatpickr("#start,#end", {
        enableTime: true,
        dateFormat: "Y-m-d H",
        time_24hr: true,
        minuteIncrement: 60
    });

    const roomCheckboxes = document.querySelectorAll('input[name="rooms"]');
    const totalCheckbox = document.querySelector('input[value="total"]');
    const otherCheckboxes = Array.from(roomCheckboxes).filter(cb => cb.value !== 'total');

    roomCheckboxes.forEach(cb => {
        cb.addEventListener('change', function () {
            if (this.value === 'total' && this.checked) {
                // Если total выбран, снимаем выбор и отключаем остальные
                otherCheckboxes.forEach(other => {
                    other.checked = false;
                    other.disabled = true;
                });
            } else if (this.value === 'total' && !this.checked) {
                // Если total снят, включаем остальные
                otherCheckboxes.forEach(other => other.disabled = false);
            } else {
                // Если выбрана комната, снимаем total и отключаем его
                const anyRoomChecked = otherCheckboxes.some(other => other.checked);
                if (anyRoomChecked) {
                    totalCheckbox.checked = false;
                    totalCheckbox.disabled = true;
                } else {
                    totalCheckbox.disabled = false;
                }
            }
        });
    });

    // Инициализация: поскольку total по умолчанию checked, отключить остальные
    otherCheckboxes.forEach(other => other.disabled = true);

    async function load() {
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const rooms = Array.from(document.querySelectorAll('input[name="rooms"]:checked')).map(input => input.value).join(",");

        const resp = await fetch(`/api/data?start=${start}&end=${end}&rooms=${rooms}`);
        const json = await resp.json();

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("chart"), {
            type: "line",
            data: {datasets: json.datasets},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: {
                        type: "time",
                        time: {
                            unit: "minute",
                            displayFormats: {
                                minute: "MM.DD HH:mm"
                            }
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 20,
                            maxRotation: 55,
                            minRotation: 45
                        }
                    },
                    y: {beginAtZero: true}
                },
                plugins: {
                    legend: {position: "top"},
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function (context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            drag: {
                                enabled: true
                            },
                            mode: 'x',
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                            modifierKey: 'shift'  // Hold shift to pan
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        let total = 0, max = 0;
        json.datasets.forEach(ds => ds.data.forEach(p => {
            total += p.y;
            if (p.y > max) max = p.y;
        }));
    }

    window.onload = () => load();
</script>
</body>
</html>